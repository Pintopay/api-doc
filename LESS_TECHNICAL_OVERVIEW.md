## Как работает интеграция партнёра с нашей платформой и BankServiceProvider

### Введение

Наша платформа обеспечивает полный цикл работы с виртуальными картами — от выпуска и пополнения до заморозки, разморозки и закрытия. Партнёр подключается к платформе через **Corp-API**, который берёт на себя всё взаимодействие с провайдером карт — **BankServiceProvider**. Таким образом, партнёр работает только с нашим API, не касаясь технических деталей взаимодействия с BankServiceProvider.

---

## Важная особенность для MasterCard (актуально на 7 марта 2025, позже появится mastercard c KYC)

- Для карт **MasterCard**, которые доступны в приложении на момент 7 марта 2025 года, **KYC-форма не требуется**.
  Это значит, что для выпуска MasterCard партнёр может сразу вызывать:

```
POST /direct/api/{partnerId}/{timestamp}/openCard
```

И не заполнять никаких данных по пользователю. Это ускоряет процесс выпуска и упрощает интеграцию.

- Для карт других типов (например, Visa) KYC остаётся обязательным, и выпуск осуществляется через:

```
POST /direct/api/{partnerId}/{timestamp}/openCardKYC
```

---

## Основные участники процесса

- **Партнёр** — клиент платформы, который хочет предоставлять своим пользователям виртуальные карты.
- **Corp-API** — наш бэкенд, обрабатывающий запросы партнёра и все взаимодействие с BankServiceProvider.
- **BankServiceProvider** — внешняя платёжная система, фактически выпускающая и обслуживающая карты.

---

## Как всё устроено в общем виде (с учётом MasterCard)

### 1. Регистрация партнёра

Партнёр предоставляет свой публичный ключ, который мы используем для проверки всех подписанных запросов. В ответ партнёр получает **partnerId**, который будет нужен для всех последующих операций.

---

### 2. Регистрация пользователя (если KYC обязателен)

Если партнёр хочет выпустить **Visa-карту**, он сначала регистрирует пользователя через `/registerUser`.

- Если выпускается **MasterCard**, этот шаг можно пропустить.

---

### 3. Выпуск карты

- Для **MasterCard**:
```
POST /direct/api/{partnerId}/{timestamp}/openCard
```
- Для **Visa**:
```
POST /direct/api/{partnerId}/{timestamp}/openCardKYC
```

В обоих случаях Corp-API проверяет баланс партнёра, сохраняет заявку и передаёт её в BankServiceProvider.

---

### 4. Подтверждение выпуска через вебхук

Как только карта выпущена, BankServiceProvider присылает вебхук `createcard` в Corp-API.
Corp-API обновляет статус заявки и сразу уведомляет партнёра через заранее заданный вебхук.

---

### Остальные шаги

Пополнение, заморозка, разморозка и закрытие карты работают одинаково для всех карт.

---

### 5. Пополнение карты

- Партнёр вызывает `/recharge`, передавая сумму и идентификатор карты.
- Corp-API проверяет баланс партнёра, списывает деньги и отправляет запрос в BankServiceProvider.
- Когда пополнение выполнено, BankServiceProvider присылает вебхук `recharge`, а Corp-API обновляет статус операции и уведомляет партнёра.

---

### 6. Заморозка/разморозка карты

Партнёр вызывает `/freezeCard` или `/unfreezeCard`, Corp-API передаёт команду в BankServiceProvider, обрабатывает вебхук и уведомляет партнёра.

---

### 7. Закрытие карты и возврат средств

Партнёр вызывает `/closeCard`, BankServiceProvider возвращает остаток баланса после закрытия карты, присылает вебхук `refund`, а Corp-API обновляет баланс партнёра и уведомляет его.

---

### 8. Передача 3DS-кодов

При необходимости BankServiceProvider присылает вебхук `3ds`, который Corp-API сразу пересылает партнёру.

---

## Безопасность интеграции

Каждый запрос подписан приватным ключом партнёра и проверяется Corp-API с использованием публичного ключа.
Подпись строится по формуле:

```
partnerId:timestamp:nonce:endpointName
```

Это защищает от подделки, перехвата и повторных атак (replay attacks).

---

## Вебхуки

Партнёр регистрирует свои вебхуки через Corp-API:

- Для событий выпуска карт.
- Для пополнений.
- Для передачи 3DS-кодов.
- Для уведомлений о транзакциях.

Corp-API использует эти вебхуки для мгновенного информирования партнёра.

---

## Что партнёр может делать через API

- Узнать информацию о себе (баланс, вебхуки, карты).
- Посмотреть историю операций.
- Получить детали карты.
- Узнать статус заявки (выпуск, пополнение и т.д.).
- Принудительно запросить статус при отсутствии вебхука.

---

## Почему это удобно

- Нет прямой интеграции с BankServiceProvider.
- Все ошибки и нестандартные кейсы обрабатывает Corp-API.
- Один интерфейс для всех операций.
- Встроенная безопасность.
- Мгновенные уведомления через вебхуки.

---

## Резюме

- **MasterCard** — без KYC, сразу через `openCard`
- **Visa** — с KYC, через `openCardKYC`
- Остальные процессы едины для всех карт
- Партнёр работает только с Corp-API, всё остальное берём на себя.